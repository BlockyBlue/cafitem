---
import Layout from '../layouts/BasicLayout.astro';
---

<Layout>
	<style slot="style">
     body {
      text-align: center;
    }
    form {
      width: 30%;
      max-width: 400px;
      height: auto;
      background-color: #ffffff;
      border-radius: 5px;
      padding: 10px;
      margin: 0 auto;
      text-align: center;
      border: 0px solid #000000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .field {
      width: 95%;
      height: 30px;
      margin: 0 auto;
      background-color: #e8f6ff;
      border: 1px solid #000000;
      border-radius: 3px;
      font-family: "Raleway", sans-serif;
      font-size: 15px;
      padding: 0 5px;
      box-sizing: border-box;
    }
    .submit {
      width: 150px;
      height: 30px;
      margin: 0 auto;
      background-color: #00d100;
      border: 2px solid #000000;
      border-radius: 3px;
      font-family: "Raleway", sans-serif;
      font-size: 15px;
      cursor: pointer;
    }
    #message-box {
      width: 95%;
      margin: 10px auto;
      padding: 10px;
      border-radius: 5px;
      font-weight: bold;
      display: none; /* Initially hidden */
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }

    /* Message box for unauthorized access */
    .message-box {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      border-radius: 8px;
      font-family: 'Raleway', sans-serif;
      font-size: 24px;
      text-align: center;
      color: white;
      z-index: 1000;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .message-box.error {
      background-color: #f44336;
    }
    .message-box.success {
      background-color: #4CAF50;
    }
	</style>
  <script slot="headScript">
          (function (global) {

        if(typeof (global) === "undefined") {
           throw new Error("window is undefined");
        }

        var _hash = "!";
        var noBackPlease = function () {
           global.location.href += "#";

            // Making sure we have the fruit available for juice (^__^)
            global.setTimeout(function () {
                global.location.href += "!";
           }, 50);
        };

        global.onhashchange = function () {
            if (global.location.hash !== _hash) {
                global.location.hash = _hash;
           }
        };

     global.onload = function () {
           noBackPlease();

         // Disables backspace on page except on input fields and textarea..
          document.body.onkeydown = function (e) {
            var elm = e.target.nodeName.toLowerCase();
            if (e.which === 8 && (elm !== 'input' && elm  !== 'textarea')) {
                e.preventDefault();
            }
            // Stopping the event bubbling up the DOM tree...
            e.stopPropagation();
         };
       }
      })(window);
  </script>
	<div slot="body">
  <header><h1>CaFitem</h1></header>
  <h2>Create Account:</h2>
  <form id="create-account-form">
    <p><input id="username" type="text" class="field" placeholder="Username"></p>
    <p><input id="password" type="password" class="field" placeholder="Password"></p>
    <div id="message-box"></div>
    <p><button id="submit" class="submit" type="submit">Create Account</button></p>
  </form>
  <p>Have an account? <a href="/login">Login</a></p>
  <a href="index.html"><button class="back-button">Back</button></a>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDIF22zN6b-YjCilsumv7VrwO3NiUeeCM4",
      authDomain: "cafitem-8de92.firebaseapp.com",
      projectId: "cafitem-8de92",
      storageBucket: "cafitem-8de92.firebasestorage.app",
      messagingSenderId: "100147713764",
      appId: "1:100147713764:web:b41169600b7c121d04bef1",
      measurementId: "G-9D859PV60C"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Function to show messages to the user
    function showMessage(message, type) {
        const messageBox = document.getElementById('message-box');
        messageBox.textContent = message;
        messageBox.className = type;
        messageBox.style.display = 'block';
    }

    // Handle the form submission for creating a new account
    const createForm = document.getElementById('create-account-form');
    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        
        // Hide any previous messages
        showMessage('', '');

        if (auth && db) {
            try {
                // Check if username already exists in Firestore
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("username", "==", username));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    showMessage('Username Taken, Please Try Another', 'error');
                    return;
                }

                // Create a temporary email using the username
                const tempEmail = `${username}@your-app-domain.com`;

                // Create user with Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, tempEmail, password);
                
                // Add the username and uid to Firestore
                await addDoc(usersRef, {
                    username: username,
                    uid: userCredential.user.uid
                });

                showMessage('Account created successfully!', 'success');
                console.log('User created and username saved:', userCredential.user);
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } catch (error) {
                console.error("Error creating account:", error);
                const errorMessage = error.message;
                showMessage(`Error: ${errorMessage}`, 'error');
            }
        } else {
            showMessage('Firebase is not initialized.', 'error');
        }
    });

  </script>
	</div>
</Layout>